name: Sync BE to Deploy Branch

on:
  push:
    branches: [dev]
    paths:
      - 'be/**'

jobs:
  sync-be-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Sync to be-deploy branch
        run: |
          # Fetch be-deploy branch
          git fetch origin be-deploy:be-deploy
          
          # Checkout be-deploy
          git checkout be-deploy
          
          # Remove old be files (keep Dockerfile, captain-definition, .gitignore)
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name 'Dockerfile' ! -name 'captain-definition' ! -name '.gitignore' -exec rm -rf {} +
          
          # Copy be folder contents from dev to root
          git checkout dev -- be/
          cp -r be/* .
          cp be/.* . 2>/dev/null || true
          rm -rf be/
          
          # Commit and push
          git add -A
          git diff --staged --quiet || git commit -m "Auto-sync BE from dev @ $(date -u +%Y-%m-%d\ %H:%M:%S)"
          git push origin be-deploy

      - name: Summary
        run: echo "âœ… BE synced to be-deploy branch"
